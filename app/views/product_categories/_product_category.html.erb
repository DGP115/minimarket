<%# Because recursion is used within the partial to display sub-categories, the partial  %>
<%# loops through a local variable.  Otherwise an endless loop results  %>

<%# Tree Structure %>

<% product_categories.each do |category, nested_categories| %>

  <li class="mt-1 ml-1" data-category-id="<%= category.id %>">
    <div class="flex items-center space-x-1">
      <% if nested_categories.present? %>
        <button type="button"
                data-action="click->tree#toggle"
                data-tree-target="toggle"
                aria-expanded="false"
                class="text-sm text-gray-500 hover:text-gray-800 focus:outline-none">
          ▶
        </button>
      <% else %>
        <span class="inline-block w-3"></span> <!-- spacer for alignment (accounting for ▶-->
      <% end %>
      
      
      <%# Product Category context menu %>
      <%# Note: 1. meaning of data-action phrase: %>
      <%#           - contextmenu is the DOM event name for the browser's right-click event %>
      <%#           - So, we are telling it to launch the context-menu controller's open method%>
      <%#       2. turbo_action: "advance" %> 
      <%#          - Without this the browser's back button doesn't take the user to the "previous" page, as they would expect  %>
      <%#            because Turbo is not doing full-page refeshes due to the turboframes in place.  %>
      <%#          - "advance" tells Turbo to update the browser's history stack %>
      <%#       3. context_menu_target: "anchor" %>
      <%#          - is declaring that this <div> is the anchor target for the context-menu controller %>
      <%#          - In other ewords, it is telling the stimulus controller the basis for positioning the pop-up menu %>

      <div data-controller="context-menu"
            data-action="contextmenu->context-menu#open" 
            class="cursor-pointer hover:bg-gray-50">

        <%= link_to category.name,
                    product_category_path(category),
                    data: { turbo_frame: "categorytree_productlist_toggle",
                            turbo_action: "advance",
                            context_menu_target: "anchor" },
                    class: "text-sm font-normal 
                            cursor-pointer rounded-md hover:bg-blue-200" %>
        <% if user_signed_in? && current_user.admin? %>
          <%= render partial: "shared/category_context_menu", locals: { record: category } %>
        <% end %>
      </div>

      <% if category.children_count > 0 %>
        <span class="text-sm font-light text-gray-600">
          [<%= category.children_count %>]
        </span>
      <% end %>

      <% if category.products_count > 0 %>
        <span class="text-sm font-light text-gray-600">
          {<%= category.products_count %>}
        </span>
      <% end %>
      

    </div>
    <% if nested_categories.present? %>
      <ul data-tree-target="children" 
          class="hidden pl-1 ml-4 border-l border-gray-300">

        <%= render partial: "product_categories/product_category", 
                   locals: { product_categories: nested_categories } %>
                  
      </ul>
    <% end %>
  </li>
<% end %>



