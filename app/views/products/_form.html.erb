<%= form_with(model: @product, local: true) do |f| %>

  <div class="grid grid-cols-1 mt-4 gap-y-6 gap-x-4 sm:grid-cols-6">
    <div class="sm:col-span-6">
      <%= f.label :title, class: "block text-sm font-semibold text-gray-700" %>
      <div class="mt-1">
        <%= f.text_field :title, label: false, 
                          class: "border shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full 
                                  border-gray-300 rounded-md pl-2" %>
      </div>
    </div>
  
    <%# NOTE: Addition of trix-content class to work-around a clash between Tailwind preflight reset %>
    <%#       and classes required by the trix editor.  Needed to get bullets to work %>
    <%#       See style sheet for definition of these overrides %>
    <div class="sm:col-span-6">
      <%= f.label :description, class: "block text-sm font-semibold text-gray-700" %>
      <div class="mt-1">
        <%= f.rich_textarea :description, 
                            class: "shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full border-gray-300 
                                    rounded-md trix-content" %>
      </div>
    </div>

    <div class="sm:col-span-1">
      <%= f.label :price, class: "block text-sm font-semibold text-gray-700" %>
      <div class="flex mt-1 rounded-md shadow-sm">
        <span class="inline-flex items-center px-3 text-gray-500 border border-r-0 border-gray-300 rounded-l-md bg-gray-50 sm:text-sm">
          $
        </span>
        <%= f.text_field :price,
                          value: number_with_precision(@product.price || 0, precision: 2, delimiter:",",
                                                        strip_insignificant_zeros: false),
                          class: "focus:ring-blue-500 focus:border-blue-500 block w-full rounded-none rounded-r-md 
                                  border-1 border-gray-300 text-center" %>
      </div>
    </div>

    <%# Allow 1 Primary image attachment (2/3 width of form) and category dropdown (1/3 width of form) side by side %>
    <div class="grid items-start grid-cols-12 gap-4 sm:col-span-6 sm:grid-cols-12">

      <%# Primary image attachment %>
      <div class="p-2 border border-gray-300 rounded-md sm:col-span-8">
        <%= f.label "Primary image:", multiple: false, class: "block text-sm font-bold text-indigo-700" %>
        <% if @product.primary_image.attached? %>
          <div class = "grid grid-cols-1 justify-items-center">

            <%= image_tag @product.primary_image.variant(resize_to_limit: [400,400]), class: "rounded-lg shadow-md" %>

          </div>
        <% end %>
        
        <div class="mt-1">
          <%= f.file_field :primary_image, multiple: false,
                            class: "block border rounded-md w-full text-sm text-gray-500
                                    file:mr-4 file:py-1 file:px-4
                                    file:rounded-md file:border-1
                                    file:text-sm file:font-semibold
                                    file:bg-indigo-100 file:text-indigo-700
                                    hover:file:bg-indigo-50" %>
        </div>
      </div>

      <%# Category dropdown section %>
      <div class="p-2 border border-gray-300 rounded-md sm:col-span-4">

        <%= f.label :product_category_id, "Category:", class: "block text-sm font-bold text-indigo-700" %>

        <div data-controller="dropdown" class="relative w-full">
          <!-- Dropdown trigger button -->
          <button type="button"
                  data-action="click->dropdown#toggle"
                  class="w-full px-3 py-1 text-left border rounded-md cursor-pointer">
            <span>
              <%# Show selected category or "Select Category"" %>
              <%= @product.product_category&.name || "Select Category" %>
            </span>
          </button>

          <!-- Dropdown menu -->
          <ul data-dropdown-target="menu" 
              class="absolute z-10 hidden w-full mt-1 overflow-y-auto bg-white border rounded-md shadow-lg max-h-60">

            <% category_tree_reformat(@product_categories).each do |(label, id, depth)| %>
              <li data-action="click->dropdown#select"
                  data-id="<%= id %>"
                  data-label="<%= label %>"
                  class="cursor-pointer hover:bg-gray-100 <%= "pl-#{depth * 4}" %>">
                <%= label %>
              </li>
            <% end %>
          </ul>

          <!-- Hidden field for product_category selected, for form submission -->
          <%= f.hidden_field :product_category_id,
                           id: "product_category_id",
                        value: @product.product_category_id,
                         data: { dropdown_target: "hidden" } %>
        </div>
      </div>
    </div>

    <%# Allow deletion of existing gallery image attachments %>
    <div class="block p-2 border border-gray-300 rounded-md sm:col-span-3 w-fit justify-items-center">
      <%= f.label "Gallery images:", multiple: true, class: "block text-sm font-bold text-indigo-700" %>
      <% if @product.images.attached? %>
        <div class = "grid grid-cols-2 gap-4 md:grid-cols-3">
          
          <% @product.images.attachments.each do |attachment| %>
            <div class="relative group">
              <%= image_tag attachment.variant(resize_to_limit: [300,300]), class: "rounded-lg shadow-md" %>
              <%# The methoid: :put is a cludge to get the method to be called. %>
              <%# Turbo_conform doesn't work with link_to.  Method call doesn't work with button_to %>
              <%= link_to "X", remove_image_product_path(@product, attachment.id), 
                                method: :put,
                                data: { turbo_confirm: "Are you sure you want to delete this attachment?" },
                                class: "absolute top-0 right-0 bg-red-600 font-sans font-bold text-yellow-300 
                                        border border-black text-xs rounded px-2 py-1 opacity-0 
                                        group-hover:opacity-100 transition" %>
            </div>
          <% end %>
        
        </div>
      <% end %>

      <%# Allow attachments of multiple gallery images %>
      <div class="sm:col-span-6">
        
        <div class="mt-1">
          <%# To make the user-selected files an addendum to what had been attached previously, %>
          <%# include previous images here as hidden items %>
          <% @product.images.each do |image| %>
            <%= f.hidden_field :images, multiple: true, value: image.signed_id %>
          <% end %>
          <%= f.file_field :images, multiple: true,
                            class: "block border rounded-md w-fit text-sm text-gray-500
                                    file:mr-4 file:py-1 file:px-4
                                    file:rounded-md file:border-1
                                    file:text-sm file:font-semibold
                                    file:bg-indigo-100 file:text-indigo-700
                                    hover:file:bg-indigo-50" %>
        </div>
      </div>
    </div>

    <div class="sm:col-span-6">
      <%= f.submit class: "button button-sm bg-blue-500 text-yellow-400 hover:scale-110 hover:invert" %>
    </div>
  </div>
<% end %>