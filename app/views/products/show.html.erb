<turbo-frame id="categorytree_productlist_toggle">

  <!-- Category / product navigation -->
  <div class="ml-6 self-center mt-4 mb-4">
    <%= link_to(product_category_path(@product.product_category_id), 
                class: "px-1 py-1") do %>
      <span>&#8617;<%= @product.product_category.name %></span>
    <% end %> 
  </div>

  <%= turbo_frame_tag @product do %>

    <!-- "target" here is the dom_id to be updated.  See _flash_messages.html.erb for 
          the setting on that dom_id -->
    <%# <%= turbo_stream.update target="flash_messages", partial: "shared/flash_messages" %> 

    <!-- Product main content -->
    <div class="flex flex-col justify-center items-center md:flex-row md:items-start space-y-2 
                md:space-y-0 md:space-x-4 lg:space-x-4 max-w-6xl w-11/12 mx-auto mt-3">

      <!-- Left column top:  Images -->
      <div data-controller="gallery">
        <%= render partial: "products/show_images", locals: { product: @product } %>
      </div>
        
      <!-- Right column top:  Product Title, price, buttons--> 
      <div class="flex flex-col justify-between h-full w-full md:w-1/3 max-w-md space-y-2">
        <%= render partial: "products/show_right_column", locals: { product: @product } %>
      </div>
      
    </div>

    <!-- Bottom: Two columns merged: Product description -->
    <% if !@product.description.blank? %>

      <div class="w-9/12 mt-2 ml-10 p-2
                  font-sans font-normal text-base
                  border rounded-md border-indigo-600
                  shadow-lg">

        <%= @product.description %>

      </div>
    <% end %>
  <% end %>


  <!-- Reviews -->
  <div id="reviews-container" class="my-3 py-6 pl-4">

    <% if @reviews.any? %>
      <h2 class="text-xl font-sans font-semibold">Reviews:</h2>
    <% end %>

    <!--If user has already reviewed this product, have them edit their review versus creating
        an additional one.  Also, don't allow seller to leave a review -->
    <% if user_signed_in? && current_user.id != @product.seller_id %>
      <% if @current_user_review != nil %>
        <!-- User has already reviewed so have them edit their existing review -->
        
        <div class="flex justify-start ml-4">
          <div class="w-1/2 max-w-lg px-2 pt-1 my-2 border border-gray-500 rounded-md bg-indigo-100">
            <p class="pl-2 text-base">Edit your review: </p>

              <%= render partial: "reviews/form", 
                        locals: { review: @current_user_review } %>

          </div>
        </div>

      <% else %>
        <!-- Show the review form to create a review-->
        <div class="px-2 pt-1 my-2 border border-gray-500 rounded-md bg-neutral-100">
          <p class="pl-2 text-base">Write a review </p>
          <div>
            <%= turbo_frame_tag dom_id(@new_review || Review.new) do %>
              <%= render partial: "reviews/form", locals: { review: @new_review } %>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>

    <%# Since we are broadcasting refreshes of product reviews (See review model), %>
    <%# this turbo_stream_from identifies the Turbo subscription for real-time updates --> %>
    <%= turbo_stream_from @product %>

    <%# This turbo_frame_tag is a marker to enable turbo to prepend new reviews here %>
    <%= turbo_frame_tag "reviews" do %>
      <%= render partial: "reviews/review", collection: @reviews, as: :review %>
    <% end %>

  </div>
</turbo-frame>

