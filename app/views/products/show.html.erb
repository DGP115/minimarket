<turbo-frame id="categorytree_productlist_toggle">

  <!-- Breadcrumb link back to product's category -->
  <div class="self-center mt-4 mb-4 ml-6">
    <%= link_to(product_category_path(@product.product_category_id), 
                class: "px-1 py-1") do %>
      <span>&#8617;<%= @product.product_category.name %></span>
    <% end %> 
  </div>

  <%# The below creates in the DOM "turbo-frame id="product_67""," for example.   %>
  <%#   This product-specific turbo-frame is used refreshed by the review model to update the  %>
  <%#   specific product page after a user review of the product has been cereated to updated. %>
  <%= turbo_frame_tag @product do %>

    <!-- Product main content -->
    <div class="flex flex-col items-center justify-center w-11/12 max-w-6xl mx-auto mt-3 space-y-2 md:flex-row md:items-start md:space-y-0 md:space-x-4 lg:space-x-4">

      <!-- Left column top:  Images -->
      <div data-controller="gallery">
        <%= render partial: "products/show_images", locals: { product: @product } %>
      </div>
        
      <!-- Right column top:  Product Title, price, buttons--> 
      <div class="flex flex-col justify-between w-full h-full max-w-md space-y-2 md:w-1/3">
        <%= render partial: "products/show_right_column", locals: { product: @product } %>
      </div>
      
    </div>

    <!-- Bottom: Two columns merged: Product description -->
    <% if !@product.description.blank? %>

      <div class="w-9/12 p-2 mt-2 ml-10 font-sans text-base font-normal border border-indigo-600 rounded-md shadow-lg">

        <%= @product.description %>

      </div>
    <% end %>
  <% end %>


  <!-- Reviews -->
  <div id="reviews-container" class="py-6 pl-4 my-3">

    <% if @reviews.any? %>
      <h2 class="font-sans text-xl font-semibold">Reviews:</h2>
    <% end %>

    <!--If user has already reviewed this product, have them edit their review versus creating
        an additional one.  Also, don't allow seller to leave a review -->
    <% if user_signed_in? && current_user.id != @product.seller_id %>
      <% if @current_user_review != nil %>
        <!-- User has already reviewed so have them edit their existing review -->
        
        <div class="flex justify-start ml-4">
          <div class="w-2/3 max-w-lg px-2 pt-1 my-2 bg-indigo-100 border border-gray-500 rounded-md">
            <p class="pl-2 text-base">Edit your review: </p>

              <%= render partial: "reviews/form", 
                        locals: { review: @current_user_review } %>

          </div>
        </div>

      <% else %>
        <!-- Show the review form to create a review-->
        <div class="px-2 pt-1 my-2 border border-gray-500 rounded-md bg-neutral-100">
          <p class="pl-2 text-base">Write a review </p>
          <div>
            <%= turbo_frame_tag dom_id(@new_review || Review.new) do %>
              <%= render partial: "reviews/form", locals: { review: @new_review } %>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>

    <%# Since we are broadcasting refreshes of product reviews (See review model), %>
    <%# this turbo_stream_from identifies the Turbo subscription for real-time updates --> %>
    <%= turbo_stream_from @product %>

    <%# This turbo_frame_tag is a marker to enable turbo to prepend new reviews here %>
    <%= turbo_frame_tag "reviews" do %>
      <%# Recall this is some Rails magic whereby the partial below is called for each review object in collection @reviews %>
      <%= render partial: "reviews/review", collection: @reviews, as: :review %>
    <% end %>

  </div>
</turbo-frame>

